datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

model Course {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String
  title       String
  description String?
  imageUrl    String?
  price       Float?
  usdPrice    Float?
  courseDuration String?
  courseTimeLimit Float?
  isPublished Boolean @default(false)

  categoryId String?   @db.Uuid
  category   Category? @relation(fields: [categoryId], references: [id])

  chapters    Chapter[]
  attachments Attachment[]
  purchases   Purchase[]
  carts       Cart[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
}

model Category {
  id      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name    String   @unique
  courses Course[]
}

model Attachment {
  id   String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name String
  url  String

  courseId String @db.Uuid
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
}

model Chapter {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  description String?
  videoUrl    String?
  position    Int
  isPublished Boolean @default(false)
  isFree      Boolean @default(false)

  muxData MuxData?

  courseId String @db.Uuid
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  userProgress UserProgress[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
}

model MuxData {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  assetId    String
  playbackId String?

  chapterId String  @unique @db.Uuid
  chapter   Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
}

model UserProgress {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId String

  chapterId String  @db.Uuid
  chapter   Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  isCompleted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, chapterId])
  @@index([chapterId])
}

model KentNote {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String
  chapterId String
  rubricId  String
  text      String
  userName  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, chapterId])
  @@index([userId, rubricId])
}

model Purchase {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId String

  courseId String @db.Uuid
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  swipeHashId String?
  userEmail String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
}

model StripeCustomer {
  id               String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String @unique
  stripeCustomerId String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserAddress {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId String @unique

  fullName String?
  address1 String?
  pinCode String?
  city String?
  state String?
  country String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Coupon{
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  courseId String @db.Uuid
  discount Float?
  codes String[]
  count Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CouponPercentage{
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  discount Float?
  codes String
  count Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ScheduledEmail {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String
  sent      Boolean  @default(false)
  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
}

model Cart {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   // linked to your auth system (Clerk, etc.)

  courseId  String   @db.Uuid
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
  @@unique([userId, courseId])
}

model MentorshipPurchase {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String
  type              String   // e.g., "acute" | "chronic"
  swipeHashId       String?
  userEmail         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ContactUs {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  email     String
  message   String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([email])
}

model Survey {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  serial              Int?      

  fullName            String?
  phone               String?
  email               String?
  city                String?
  currentStatus       String?
  currentStatusOther  String?

  practiceTypes       String[]
  practiceOther       String?

  experience          String?

  timeConsumption     String[]
  timeConsumptionOther String?

  softwareUsedLaptop        String?
  softwareUsedMobile        String?
  helpfulLaptop       String?
  helpfulMobile       String?

  repertoryUsed       String?
  rubricSource        String?
  materiaMedica       String?

  frustrationLaptop   String?
  frustrationMobile   String?

  learningSources     String[]
  cmePlatforms        String?

  toolPhrasing        String?
  toolRepertory       String?
  toolDifferential    String?
  featureSuggestions  String?

  paymentModel        String?

  earlyAccess         String?
  contactPermission   String?

  consent1            Boolean?
  consent2            Boolean?
  consent3            Boolean?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([createdAt])
}


model LoyaltyPoints {
  id        Int      @id @default(autoincrement())
  userId    String   @unique
  points    Int      @default(0)
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

// KENT DATABASE APPROACh

model Book {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  bookName  String    @unique
  chapters  Content[]
  createdAt DateTime  @default(now())
}

model Content {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  icon        String?
  description String?
  book        Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  bookId      String   @db.Uuid
  rubrics     Rubric[]

  @@index([bookId])
}

model Rubric {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String
  meaning         String?
  chapter         Content          @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  chapterId       String           @db.Uuid
  remedies        Remedy[]
  notes           Note[]
  crossReferences CrossReference[]

  // Essential for fast sorting and pagination by name
  @@index([chapterId, name]) 
  // Essential for searching rubrics by name
  @@index([name])
}

model Remedy {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  abbr     String
  grade    Int
  fullForm String?
  description String? @db.Text
  rubric   Rubric @relation(fields: [rubricId], references: [id], onDelete: Cascade)
  rubricId String @db.Uuid

  @@index([rubricId])
}

model Note {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type     String
  source   String?
  text     String  @db.Text // Use Text for long notes
  rubric   Rubric  @relation(fields: [rubricId], references: [id], onDelete: Cascade)
  rubricId String  @db.Uuid

  @@index([rubricId])
}

model CrossReference {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  chapterTarget String // target chapter name or ID
  rubricTarget  String // target rubric name
  rubric        Rubric @relation(fields: [rubricId], references: [id], onDelete: Cascade)
  rubricId      String @db.Uuid

  @@index([rubricId])
}